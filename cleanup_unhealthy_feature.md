# 删除不健康节点功能文档

## 功能概述
新增"删除不健康节点"功能，允许用户一键删除所有当前不健康的代理节点并自动保存到配置文件（nodes.txt）。

## 后端API实现

### 新增端点
- **POST** `/api/nodes/cleanup-unhealthy` - 删除所有不健康的节点

### 功能逻辑
1. **节点识别**: 扫描所有节点，识别已完成健康检查但当前不可用的节点（`InitialCheckDone=true && Available=false`）
2. **批量删除**: 逐个删除不健康的节点，调用现有的 `DeleteNode` 方法
3. **自动保存**: 删除操作会自动调用配置保存，更新 nodes.txt 文件
4. **错误处理**: 部分节点删除失败时会继续处理其他节点，并返回详细结果

### API响应
```json
{
  "message": "已删除 3 个不健康节点，请点击重载使配置生效",
  "deleted": 3,
  "total": 4
}
```

**特殊情况**:
- 没有不健康节点时：`{"message": "没有发现不健康的节点", "deleted": 0}`
- 部分删除失败：包含删除数量和总数量信息

## 前端界面实现

### 新增按钮
- **位置**: 在"导出健康节点"按钮旁边
- **样式**: 危险操作按钮（`btn-danger`）
- **图标**: 删除垃圾桶图标

### 交互流程
1. **确认对话框**:
   ```
   确定要删除所有不健康的节点吗？

   这将删除所有已完成健康检查但当前不可用的节点，并自动保存配置。
   ```

2. **执行删除**: 调用API进行批量删除操作

3. **结果反馈**: 显示删除结果的成功提示

4. **重载确认**: 删除成功后询问是否立即重载配置
   ```
   是否立即重载配置以使更改生效？

   重载将中断所有现有连接。
   ```

### JavaScript函数
```javascript
async function cleanupUnhealthyNodes() {
    // 确认对话框
    // API调用: POST /api/nodes/cleanup-unhealthy
    // 结果处理
    // 重载询问
}
```

## 不健康节点定义

### 节点状态分类
- **健康节点**: `InitialCheckDone=true && Available=true`
- **不健康节点**: `InitialCheckDone=true && Available=false`
- **未检查节点**: `InitialCheckDone=false`（不会被删除）

### 过滤条件
只删除**明确不健康**的节点：
- ✅ 已完成初始健康检查
- ✅ 当前状态为不可用
- ❌ 未完成检查的节点（保留）
- ❌ 当前健康的节点（保留）

## 使用场景

### 适用情况
- 节点长期失效，需要清理配置
- 订阅更新后包含大量无效节点
- 定期维护代理池，保持配置整洁
- 减少无效节点的健康检查开销

### 操作建议
1. **定期探测**: 先执行"探测全部"确保节点状态准确
2. **确认删除**: 查看节点列表中的状态标识
3. **及时重载**: 删除后重载配置使更改生效
4. **备份配置**: 重要操作前备份现有配置

## 安全特性

### 操作保护
- **认证要求**: 需要登录认证
- **确认对话框**: 二次确认防止误操作
- **详细日志**: 记录删除失败的节点信息

### 错误处理
- **部分失败**: 继续删除其他节点，记录失败信息
- **网络异常**: 前端错误提示，不影响服务稳定性
- **并发安全**: 使用互斥锁保护配置修改

## 与现有功能的关系

### 与节点管理API集成
- 复用现有的 `DeleteNode` 方法
- 保持与单节点删除相同的权限和错误处理
- 配置保存机制完全一致

### 与重载功能配合
- 删除完成后提示用户重载配置
- 重载操作会中断现有连接（重要提示）
- 重载后节点列表立即更新

### 与导出功能互补
- "导出健康节点": 导出当前可用的节点
- "删除不健康节点": 清理不可用的节点
- 两个功能配合使用可快速优化节点池

## 部署和测试

### 测试步骤
1. 准备包含健康和不健康节点的环境
2. 验证不健康节点的状态显示
3. 测试删除功能的完整流程
4. 确认配置文件的正确更新
5. 验证重载后节点列表的更新

### 预期结果
- 配置文件中删除不健康节点
- 健康节点完全保留
- 未检查节点完全保留
- 配置格式和结构保持一致